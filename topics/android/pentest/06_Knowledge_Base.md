# Knowledge Base: The Anti-Hallucination Engine

## 1. Overview: RAG > Creativity

In Security, "Creativity" without "Knowledge" is dangerous (Hallucination).
We do not want the AI to *invent* a Frida script. We want it to *retrieve* a proven one and adapt it.

This document defines the **Retrieval Augmented Generation (RAG)** system and the **Validated Script Repository**.

---

## 2. The Knowledge Base Structure

The KB is a static repository (Git Submodule) attached to the Engine.

```text
/knowledge_base
  /docs
    /mstg              # OWASP Mobile Security Testing Guide (Markdown)
    /cwe               # Common Weakness Enumeration definitions
  /scripts
    /frida
      /bypass_ssl      # Verified SSL Pinnning Bypasses
      /bypass_root     # Verified Root Detection Bypasses (Magisk, Shamiko)
      /trace           # Tracing scripts (OkHttp, SQLite)
    /python
      /fuzzers         # Radamsa wrappers, Intent fuzzers
  /payloads
    /sqli              # Polyglot SQL Injection strings
    /xss               # Android WebView XSS vectors
```

---

## 3. RAG Workflow (Retrieval Loop)

When the AI needs to solve a problem, it **MUST** consult the KB first.

### Scenario: "Bypass Root Detection"

1.  **Query**: Agent searches KB vector store for "Root Detection Bypass".
2.  **Retrieval**: System returns:
    *   `scripts/frida/bypass_root/universal_check_hook.js` (Score: 0.95)
    *   `docs/mstg/0x05j-Testing-Resiliency-Against-Reverse-Engineering.md` (Score: 0.88)
3.  **Synthesis**:
    *   **Bad AI**: Writes a random `return false` hook for a non-existent function `System.isRooted()`.
    *   **RAG AI**: "I found a verified script `universal_check_hook.js`. It hooks `java.io.File.exists`. I will adapt it to the target app's package name."

---

## 4. The Validated Script Repository

This is the "Gold Standard" library.
**Rule**: AI cannot execute code that is not based on a template from this repo.

### 4.1 Maintenance
*   **Human Curator**: A Senior Engineer must verify every script in `/scripts`.
*   ** Automated Test**: Each script must pass a CI unit test against a "Vulnerable Android App" (e.g., GoatDroid) to ensure it actually works.
    *   *If `bypass_ssl.js` fails to bypass SSL on the test app, it is flagged BROKEN and removed from the RAG index.*

### 4.2 Categories

#### A. The "Swiss Army Knife" (Frida)
*   **SSL Unpinning**: Scripts for OkHttp3, TrustManager, and NetworkSecurityConfig.
*   **Anti-Debug**: Scripts to hook `ptrace`, `fork`, and `Debug.isDebuggerConnected`.
*   **Crypto Sniffer**: Scripts to hook `javax.crypto.Cipher` and dump keys/IVs.

#### B. The "Hammer" (Python)
*   **Intent Flooder**: Scripts to generate malformed Intents (Null extras, Oversized buffers).
*   **Deep Link Fuzzer**: Scripts to traverse `adb shell am start ...` with fuzz payloads.

---

## 5. Hallucination Firewall

We implement a **Syntax Validator** between the AI and the Device.

**Logic**:
1.  AI Generates Frida Script.
2.  **Validator**:
    *   Checks for common hallucinations (e.g., using `console.log` instead of `send` in older Frida versions).
    *   Checks if the hooked class `com.target.Foo` *actually exists* in the decompiled `classes.dex`.
3.  **Result**:
    *   If Class Not Found: **REJECT**. "Error: Class `com.target.Foo` does not exist. Do not hallucinations class names. Check the Smali again."
    *   If Valid: **Allow** execution.

This strict validation forces the AI to be grounded in the actual codebase.
