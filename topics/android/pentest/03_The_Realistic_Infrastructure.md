# The Realistic Infrastructure: The Workbench

## 1. Overview: Stability > Scalability

The critique of "Device Farms" was correct: 20 unstable devices are useless. Engine 4.0 focuses on the **Workbench Concept**: A small, highly controlled, high-fidelity environment.

We trade **Quantity** (Scale) for **Quality** (Reliability).

---

## 2. Hardware Design (The Bench)

### 2.1 The "Golden Device"
Instead of a fleet, we use 1-3 dedicated "Golden Devices".
*   **Primary Model**: **Google Pixel 6 / 7**.
    *   *Why*: KVM support (for virtualized exploits), standard AOSP mainline support, unlockable bootloader.
    *   *Specs*: 128GB Storage (needed for large dumps), 8GB+ RAM.
*   **Secondary Model**: **Samsung Galaxy (Knox)** (Optional).
    *   *Why*: To test OEM-specific behaviors, though harder to root/instrument.

### 2.2 Power & Connection Engineering
*   **Smart Plug**: **Zigbee/Matter Smart Plug** (e.g., Sonoff S31).
    *   *Purpose*: The "Option Z" nuclear reset. Controlled via Home Assistant or Python script (`kasa` lib) to cut power when the OS freezes.
*   **USB Hub**: **Acasis 10-port USB 3.0 Hub (Powered)** or **StarTech Industrial Hub**.
    *   *Requirement*: Per-port power isolation (prevents one shorted device from killing the bus) and 5V/2.4A dedicated charging.
*   **Data Layout**:
    *   **Host Port**: Direct USB-C 3.2 Gen 2 Motherboard connection.
    *   **Cables**: **Anker PowerLine+ III** (Certified Data transfer). Cheap cables cause 90% of ADB dropouts.

---

## 3. The Software Stack (Reliability Layer)

We assume the App is hostile and ADB is flaky.

### 3.1 The Custom ROM (AOSP+)
We do NOT use Stock OS. We build **LineageOS** or **AOSP** with specific patches:
*   **KernelSU**: Baked into the Kernel Image (GKI).
    *   *Advantage*: Invisible to userspace applications. No `su` binary in `/system/bin`.
*   **System Cert Injection**:
    *   Mitmproxy CA is moved to `/system/etc/security/cacerts/` during the build process.
    *   Result: SSL interception works natively without Magisk modules.
*   **Aggressive Debloat**:
    *   Remove GMS (Google Mobile Services) if not strictly required, or use MicroG. Reduces background noise in traffic logs.

### 3.2 The Watchdog Architecture
We wrap ADB in a Python Supervisor.

```python
# watchdog.py - The Reliability Supervisor
import subprocess
import time
from smart_plug import cycle_power

def check_device_health(device_id):
    try:
        # PING 1: ADB State
        state = subprocess.check_output(["adb", "-s", device_id, "get-state"])
        if b"device" not in state:
            return False
            
        # PING 2: File System Writable?
        subprocess.check_call(["adb", "-s", device_id, "shell", "touch", "/sdcard/health_check"])
        return True
    except:
        return False

def recover_device(device_id):
    print(f"WARN:/ Device {device_id} Unhealthy. Attempting Soft Reset...")
    subprocess.call(["adb", "kill-server"])
    subprocess.call(["adb", "start-server"])
    
    if not check_device_health(device_id):
        print(f"CRITICAL: Device {device_id} Dead. Triggering HARD RESET.")
        cycle_power(device_id) # Toggles Smart Plug
        time.sleep(60) # Wait for boot
```

---

## 4. Cost vs. Benefit Analysis

Why this approach is superior to a 20-device farm?

| Metric            | Farm Strategy (20x Used Phones)       | Workbench Strategy (2x Golden Pixels)  |
| :---------------- | :------------------------------------ | :------------------------------------- |
| **Hardware Cost** | ~$3,000                               | ~$800                                  |
| **Maintenance**   | 20 hrs/week (Battery swaps, flashing) | 2 hrs/week (Updates)                   |
| **Reliability**   | 60% (Something is always broken)      | 99% (SLA Guaranteed)                   |
| **Data Quality**  | Low (Noise, disconnection)            | High (Clean traces, steady connection) |
| **Throughput**    | High (Parallel scanning)              | Medium (Sequential deep dive)          |

**Conclusion**: For **Penetration Testing** (Deep Dive), the Workbench wins. The Farm is only useful for **Compatibility Testing** (Shallow), which is not our goal.

---

## 5. Capacity Planning

*   **Throughput**: A single Workbench (1 Human + 1 AI + 2 Devices) can process **1 Deep Dive APK per 2 days**.
*   **Scale Out**: To double capacity, add another Workbench (Human + Kit), not just more phones. The **Human is the scaling bottleneck**, not the hardware.
